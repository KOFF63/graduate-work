{% extends "materials/base.html" %}

{% block title %}Поиск: {{ query }}{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Заголовок и статистика -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="mb-3">
                <i class="bi bi-search"></i> Результаты поиска
            </h2>
            {% if query %}
            <p class="lead">
                По запросу «<strong>{{ query }}</strong>»
                {% if total_results > 0 %}
                    найдено <span class="badge bg-primary">{{ total_results }}</span> материалов
                {% else %}
                    ничего не найдено
                {% endif %}
                {% if search_time %}
                    <small class="text-muted ms-2">(за {{ search_time }} мс)</small>
                {% endif %}
            </p>
            {% endif %}
        </div>
        <div class="col-md-4">
            <!-- Форма уточнения поиска -->
            <form method="get" action="{% url 'search_materials' %}" class="mt-3 mt-md-0">
                <div class="input-group">
                    <input type="text"
                           name="q"
                           class="form-control"
                           value="{{ query }}"
                           placeholder="Уточните поиск..."
                           aria-label="Уточнить поиск">
                    <button class="btn btn-outline-primary" type="submit">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Предложения (если мало результатов) -->
    {% if suggestions %}
    <div class="alert alert-info mb-4">
        <i class="bi bi-lightbulb"></i> Возможно, вы искали:
        {% for suggestion in suggestions %}
            <a href="{% url 'search_materials' %}?q={{ suggestion|urlencode }}" class="badge bg-light text-dark text-decoration-none me-2 p-2">
                {{ suggestion }}
            </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Результаты поиска -->
    {% if materials %}
    <div class="row g-4">
        {% for material in materials %}
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 shadow-sm hover-card">
                <div class="card-body">
                    <!-- Верхняя строка с типом и датой -->
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="badge bg-secondary">
                            {% if material.material_type == 'lecture' %}
                                <i class="bi bi-mic"></i> Лекция
                            {% elif material.material_type == 'book' %}
                                <i class="bi bi-book"></i> Книга
                            {% elif material.material_type == 'practice' %}
                                <i class="bi bi-pencil"></i> Практика
                            {% elif material.material_type == 'test' %}
                                <i class="bi bi-check-square"></i> Тест
                            {% elif material.material_type == 'presentation' %}
                                <i class="bi bi-easel"></i> Презентация
                            {% elif material.material_type == 'video' %}
                                <i class="bi bi-camera-reels"></i> Видео
                            {% else %}
                                <i class="bi bi-file-earmark"></i> Другое
                            {% endif %}
                        </span>

                        <!-- Индикатор релевантности -->
                        {% if material.relevance_score %}
                        <span class="badge bg-success" title="Релевантность">
                            {{ material.relevance_score }}%
                        </span>
                        {% endif %}
                    </div>

                    <!-- Название -->
                    <h6 class="card-title mb-2">
                        <a href="#" class="text-decoration-none text-dark stretched-link">
                            {{ material.title }}
                        </a>
                    </h6>

                    <!-- Описание -->
                    <p class="card-text small text-muted mb-3">
                        {{ material.description|truncatewords:20 }}
                    </p>

                    <!-- Теги и предмет -->
                    <div class="mb-3">
                        <span class="badge bg-primary me-1">{{ material.subject.name }}</span>
                        {% if material.matched_terms %}
                            {% for term in material.matched_terms %}
                                <span class="badge bg-warning text-dark">{{ term }}</span>
                            {% endfor %}
                        {% endif %}
                        {% if material.tags %}
                            {% for tag in material.tags.split|slice:":3" %}
                                <span class="badge bg-light text-dark">{{ tag }}</span>
                            {% endfor %}
                        {% endif %}
                    </div>

                    <!-- Нижняя строка с кнопками -->
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">
                            <i class="bi bi-calendar3"></i> {{ material.upload_date|date:"d.m.Y" }}
                        </small>
                        <div>
                            {% if material.file %}
                            <a href="{{ material.file.url }}"
                               class="btn btn-sm btn-success me-1"
                               download
                               onclick="event.preventDefault(); window.location.href='{{ material.file.url }}'">
                                <i class="bi bi-download"></i>
                            </a>
                            {% endif %}
                            {% if material.external_link %}
                            <a href="{{ material.external_link }}"
                               target="_blank"
                               class="btn btn-sm btn-info">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Пагинация -->
    {% if is_paginated %}
    <nav class="mt-5">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?q={{ query }}&page={{ page_obj.previous_page_number }}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?q={{ query }}&page={{ num }}">{{ num }}</a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?q={{ query }}&page={{ page_obj.next_page_number }}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- Нет результатов -->
    <div class="text-center py-5">
        <div class="display-1 text-muted mb-4">
            <i class="bi bi-emoji-frown"></i>
        </div>
        <h3 class="mb-3">Ничего не найдено</h3>
        <p class="text-muted mb-4">
            По вашему запросу «{{ query }}» ничего не найдено.
            Попробуйте изменить запрос или использовать другие ключевые слова.
        </p>

        <!-- Советы по поиску -->
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-lightbulb"></i> Советы:</h6>
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">✓ Проверьте орфографию</li>
                            <li class="mb-2">✓ Используйте более общие слова</li>
                            <li class="mb-2">✓ Попробуйте искать на английском</li>
                            <li>✓ Используйте ключевые слова из названий предметов</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.hover-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.12) !important;
}
</style>
{% endblock %}